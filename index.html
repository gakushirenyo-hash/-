<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ページ進捗グリッド</title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:#171a2b;
      --text:#e9ecff;
      --muted:#aab0d6;
      --line:#2a2f52;
      --focus:#7aa2ff;
      --danger:#ff6b6b;

      /* 未着手 */
      --c0:hsl(220 18% 28%);

      /* 進捗色 */
      --c1:hsl(215 45% 48%); /* 青 */
      --c2:hsl(195 42% 46%); /* 青緑 */
      --c3:hsl(165 40% 44%); /* 緑 */
      --c4:hsl(95  40% 48%); /* 黄緑 */
      --c5:hsl(55  45% 52%); /* 黄 */
      --c6:hsl(30  50% 54%); /* 橙 */
      --c7:hsl(0   55% 56%); /* 赤（完成） */
      --c8:hsl(285 45% 54%); /* 紫（修正） */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #1c2150 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{ max-width:1220px; margin:0 auto; padding:18px; }
    h1{ font-size:18px; margin:0; font-weight:700; }

    .panel{
      background: rgba(23,26,43,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
    }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    label{ color:var(--muted); font-size:12px; }
    input[type="number"], input[type="text"], select{
      background:#0f1330;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      min-width:160px;
    }
    input:focus, select:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(122,162,255,.25);
    }
    button{
      background:#2a3270;
      border:1px solid #3b46a6;
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      white-space: nowrap;
    }
    button:hover{ filter:brightness(1.08); }
    button.secondary{
      background:#10143a;
      border:1px solid var(--line);
      color:var(--muted);
      font-weight:600;
    }
    button.danger{
      background: rgba(255,107,107,.15);
      border:1px solid rgba(255,107,107,.55);
      color:#ffd7d7;
    }
    button.small{
      padding:6px 10px;
      font-size:12px;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f1330;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
      white-space:pre-wrap;
    }

    /* --- Dashboard (Horizontal Scroll) --- */
    .dash{
      display:flex;
      gap:10px;
      overflow-x:auto; 
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; 
      margin-bottom:12px;
    }
    .dash::-webkit-scrollbar{ height:6px; }
    .dash::-webkit-scrollbar-thumb{ background:rgba(42,47,82,.8); border-radius:4px; }
    .dash::-webkit-scrollbar-track{ background:transparent; }

    .dashCard{
      flex: 0 0 calc((100% - 30px) / 4);
      min-width: 200px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(15,19,48,.85);
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, filter .15s ease, border-color .15s ease, box-shadow .15s ease;
      position:relative;
      overflow:hidden;
      min-height:108px;
    }
    .dashCard:hover{ filter:brightness(1.08); }
    .dashCard:active{ transform: translateY(1px); }
    .dashCard.active{
      border-color: rgba(122,162,255,.8);
      box-shadow: 0 0 0 3px rgba(122,162,255,.18);
    }
    .dashTop{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-bottom:8px;
    }
    .dashTitle{
      font-weight:900;
      font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 78%;
    }
    .badge{
      font-size:11px;
      color: rgba(233,236,255,.92);
      border:1px solid var(--line);
      background: rgba(16,20,58,.55);
      padding:4px 8px;
      border-radius:999px;
      flex: 0 0 auto;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(43,49,87,.9);
      border:1px solid rgba(42,47,82,.85);
      overflow:hidden;
      margin-bottom:8px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: var(--c7);
      transition: width .2s ease;
    }
    .dashNums{
      display:flex; flex-wrap:wrap; gap:8px;
      font-size:12px; color:var(--muted);
      margin-bottom:8px;
    }
    .mini{
      display:flex; align-items:center; gap:6px;
      border:1px solid var(--line);
      background: rgba(16,20,58,.35);
      padding:4px 8px;
      border-radius:999px;
    }
    .dot{ width:10px; height:10px; border-radius:999px; border:1px solid rgba(42,47,82,.8); }
    .stageLine{
      margin-top:6px;
      display:flex; flex-wrap:wrap; gap:6px;
      color: rgba(233,236,255,.78);
      font-size:11px;
    }
    .stageChip{
      display:flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(42,47,82,.85);
      background: rgba(15,19,48,.65);
      max-width:100%;
      white-space:nowrap;
    }
    .stageChip span.txt{
      overflow:hidden; text-overflow:ellipsis; max-width: 120px;
    }

    details{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0f1330;
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      color:var(--text);
      font-weight:900;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
      
    .cfgList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .cfgRow{
      display:flex;
      gap:8px;
      align-items:center;
      background: rgba(16,20,58,.55);
      padding:8px;
      border-radius:10px;
      border:1px solid var(--line);
    }
    .cfgRow input{ flex:1; min-width:unset; }
    .cfgRow .idLabel{ font-size:10px; color:var(--muted); min-width:40px; }
      
    .cfgActions{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .cfgActions .spacer{ flex:1; }

    .stats{ margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; color:var(--muted); font-size:12px; }
    .pill{ background:#0f1330; border:1px solid var(--line); border-radius:999px; padding:6px 10px; display:flex; align-items:center; gap:8px; }

    .legend{ margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
    .legend .item{
      display:flex; align-items:center; gap:8px;
      background:#0f1330; border:1px solid var(--line); border-radius:999px;
      padding:6px 10px; font-size:12px; color:var(--muted);
      cursor:pointer; user-select:none;
    }
    .legend .item.active{
      border-color: rgba(122,162,255,.7);
      box-shadow: 0 0 0 3px rgba(122,162,255,.18);
      color:var(--text);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(var(--cols, 12), minmax(34px, 1fr));
      gap:8px;
    }
    .cell{
      user-select:none;
      border-radius:10px;
      border:1px solid var(--line);
      padding:10px 6px 22px;
      text-align:center;
      font-weight:900;
      cursor:pointer;
      position:relative;
      background: var(--c0);
      transition: transform .05s ease, filter .15s ease, background .2s ease;
    }
    .cell:hover{ filter:brightness(1.08); }
    .cell:active{ transform: translateY(1px); }
    .cell .sub{ position:absolute; left:8px; top:6px; font-size:10px; color:rgba(233,236,255,.75); font-weight:800; }
    .cell .stage{
      position:absolute; left:8px; right:8px; bottom:6px;
      font-size:10px; font-weight:800; color:rgba(233,236,255,.9);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-align:left;
    }

    .footer{ margin-top:12px; color:var(--muted); font-size:12px; line-height:1.7; }

    @media (max-width: 980px){
      .dashCard{ flex: 0 0 calc((100% - 10px) / 2); }
    }
    @media (max-width: 560px){
      .dashCard{ flex: 0 0 100%; }
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: repeat(var(--cols, 8), minmax(34px, 1fr)); }
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:6px 0 10px;
    }
    .projEdit{
      margin:0;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0f1330;
      padding:8px 10px;
      min-width:260px;
    }
    .projEdit > summary{
      font-weight:900;
      color:var(--text);
    }
    .projEdit[open]{ padding-bottom:12px; }

    .controls{
      display:grid;
      grid-template-columns: 200px 1fr 120px auto;
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .ctl label{ display:block; margin-bottom:6px; }
    .ctl.small input{ min-width:unset; }
    .ctl.actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .ctl.status{
      grid-column: 1 / -1;
    }
    .ctl.status .msg{
      margin-top:0;
    }

@media (max-width: 1100px){
  .wrap{ padding:12px; }
  .panel{ padding:12px; }
  .dashCard{ min-height:96px; }

  .controls{
    display:flex;
    flex-wrap:nowrap;
    gap:10px;
    align-items:flex-end;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }

  .controls > .ctl{
    flex: 0 0 auto;
  }

  #msg{
    margin-top:0;
    white-space:pre-wrap;
  }
}

@media (max-width: 720px){
  .topbar{ flex-direction:column; align-items:stretch; }
  .projEdit{ min-width:unset; }
}

  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <h1>ページ進捗グリッド</h1>
<div class="topActions">
  <button id="buildBtn">作成/更新</button>
  <button class="secondary" id="setStageBtn">選択工程に一括</button>
  <button class="secondary" id="restoreBtn">バックアップ復元</button>
  <button class="secondary" id="clearBtn">全て未着手</button>
  <button class="danger" id="resetBtn">リセット</button>
</div>

      <details class="projEdit">
        <summary>作品リスト編集（追加・削除）</summary>
        <div class="cfgList" id="cfgList"></div>
        <div class="cfgActions">
          <button id="addProjectBtn">＋ 作品を追加</button>
          <div class="spacer"></div>
          <button class="secondary" id="saveProjectsBtn">名前を保存</button>
          <button class="secondary" id="resetProjectsBtn" title="リストを初期状態に戻します">リスト初期化</button>
        </div>
        <div class="msg" id="cfgMsg">※作品を追加・削除できます。削除時はデータの消去も選択可能です。</div>
      </details>
    </div>

    <div class="panel">

      <div class="dash" id="dash"></div>

      <div class="controls">
        <div class="ctl">
          <label>作品セレクタ</label>
          <select id="projectSelect"></select>
        </div>

        <div class="ctl small">
          <label>ページ数</label>
          <input id="totalPages" type="number" min="1" max="5000" step="1" placeholder="例：32" />
        </div>

        <div class="ctl small">
          <label>列数（見た目）</label>
          <input id="cols" type="number" min="4" max="30" step="1" value="12" />
        </div>


<div class="ctl">
  <div class="msg msgInline" id="msg">
    準備中…
  </div>
</div>


      </div>

      <div class="stats" id="stats"></div>
      <div class="legend" id="legend"></div>
      <div class="grid" id="grid"></div>

      <div class="footer">
        ・ダッシュボードは横スクロール可能です。クリックでその作品に切り替わります。<br>
        ・クリックで次工程へ。<b>Shift+クリック</b>で戻る（右クリックでも進む）。<br>
        ・ID管理のため、作品名を変更しても進捗は維持されます。
      </div>
    </div>
  </div>

  <script>
    (function(){
      const els = {
        dash: document.getElementById('dash'),
        projectSelect: document.getElementById('projectSelect'),
        totalPages: document.getElementById('totalPages'),
        cols: document.getElementById('cols'),
        buildBtn: document.getElementById('buildBtn'),
        setStageBtn: document.getElementById('setStageBtn'),
        restoreBtn: document.getElementById('restoreBtn'),
        clearBtn: document.getElementById('clearBtn'),
        resetBtn: document.getElementById('resetBtn'),
        grid: document.getElementById('grid'),
        stats: document.getElementById('stats'),
        legend: document.getElementById('legend'),
        msg: document.getElementById('msg'),

        cfgList: document.getElementById('cfgList'),
        cfgMsg: document.getElementById('cfgMsg'),
        addProjectBtn: document.getElementById('addProjectBtn'),
        saveProjectsBtn: document.getElementById('saveProjectsBtn'),
        resetProjectsBtn: document.getElementById('resetProjectsBtn'),
      };

      const STORAGE_PREFIX = 'pageGridProgressStages::';
      const PROJECTS_KEY_V2 = 'pageGridProjects::list_v2';
      const PROJECTS_KEY_OLD = 'pageGridProjects::list_v1';
      const MIGRATE_FLAG_KEY = 'pageGridProjects::migrated_v1_to_v2_done';

      const DEFAULT_PROJECT_OBJS = [
        { id: 'p1', name: '作品A' },
        { id: 'p2', name: '作品B' },
        { id: 'p3', name: '作品C' },
        { id: 'p4', name: '作品D' }
      ];

      const STAGES = [
        { id: 0, name: '未着手', cssVar: '--c0' },
        { id: 1, name: '下書き', cssVar: '--c1' },
        { id: 2, name: 'キャラペン', cssVar: '--c2' },
        { id: 3, name: 'キャラ仕上', cssVar: '--c3' },
        { id: 4, name: '背景', cssVar: '--c4' },
        { id: 5, name: 'アシ', cssVar: '--c5' },
        { id: 6, name: '全体仕上', cssVar: '--c6' },
        { id: 7, name: '完成', cssVar: '--c7' },
        { id: 8, name: '修正', cssVar: '--c8' },
      ];

      let selectedStageId = 7;
      let currentProjectId = 'p1'; 
      
      // 【安全対策】メモリ状態と保存IDの厳密管理
      let activeState = null;
      let activeStateProjectId = null; 
      let saveDebounceTimer = null;
      let pendingSaveProjectId = null;
      // 【高速化】カウントキャッシュ
      let activeCounts = null;

      function say(t){ els.msg.textContent = t; }
      function cfgSay(t){ els.cfgMsg.textContent = t; }

      function genId() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return 'p' + crypto.randomUUID();
        }
        return 'p' + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
      }

      function clampStage(n){
        const max = STAGES.length - 1;
        n = Number(n);
        if (!Number.isFinite(n)) return 0;
        n = n | 0;
        if (n < 0) return 0;
        if (n > max) return max;
        return n;
      }

      function stageInfo(id){
        return STAGES.find(s => s.id === id) || STAGES[0];
      }

      // --- Storage Keys ---
      function storageKeyFor(id){
        return STORAGE_PREFIX + 'id:' + encodeURIComponent(id);
      }
      function backupKeyFor(id){
        return STORAGE_PREFIX + 'backup:' + encodeURIComponent(id);
      }
      function legacyStorageKeyForName(name){
        const k = (name || '').trim() || 'default';
        return STORAGE_PREFIX + 'k:' + encodeURIComponent(k);
      }
      function legacyStorageKeyForNameOld(name){
        const k = (name || '').trim();
        return STORAGE_PREFIX + (k ? k : 'default');
      }

      // --- Project List Normalization ---
      function normalizeProjects(list) {
        const map = new Map();
        let changed = false;
        const src = Array.isArray(list) ? list : [];

        for (let i = 0; i < src.length; i++) {
          const p = src[i] || {};
          let id = (typeof p.id === 'string' ? p.id : String(p.id ?? '')).trim();
          let name = (typeof p.name === 'string' ? p.name : String(p.name ?? '')).trim();
          if (!id) { id = genId(); changed = true; }
          if (map.has(id)) changed = true;
          map.set(id, { id, name });
        }

        let out = Array.from(map.values());
        const finalOut = [];
        for(let i=0; i<out.length; i++){
            if(i >= 50) { changed = true; break; }
            let p = out[i];
            if(!p.name){ p.name = `作品 ${i+1}`; changed = true; }
            finalOut.push(p);
        }
        out = finalOut;
        if (out.length === 0) {
          out.push({ id: genId(), name: '新規作品' });
          changed = true;
        }
        return { list: out, changed };
      }

      function isPlausibleStateObj(o){
        if (!o || typeof o !== 'object') return false;
        const tp = Number(o.totalPages);
        const hasPages = Number.isFinite(tp) && tp > 0 && tp <= 5000;
        const hasStage = Array.isArray(o.stage) && o.stage.length > 0;
        return hasPages || hasStage;
      }

      function sanitizeState(raw){
        if (!raw) return { state: null, changed: false };
        let changed = false;
        let pages = Number(raw?.totalPages);
        const stageLen = Array.isArray(raw?.stage) ? raw.stage.length : 0;
        const isPagesValid = Number.isFinite(pages) && pages >= 1 && pages <= 5000;

        if (!isPagesValid) {
          if (stageLen >= 1) pages = Math.min(stageLen, 5000);
          else pages = 32; 
          changed = true;
        }

        let arr = raw?.stage;
        if (!Array.isArray(arr)){
          arr = Array(pages).fill(0);
          changed = true;
        } else {
          if (arr.length !== pages){
            if (arr.length < pages){
              const fill = Array(pages - arr.length).fill(0);
              arr = arr.concat(fill);
            } else {
              arr = arr.slice(0, pages);
            }
            changed = true;
          }
          const cleanArr = arr.map(v => {
            const c = clampStage(v);
            if (c !== v) changed = true;
            return c;
          });
          arr = cleanArr;
        }
        return { state: { totalPages: pages, stage: arr }, changed: changed };
      }

      // --- Projects Management ---
      function loadProjects(){
        try {
          const rawV2 = localStorage.getItem(PROJECTS_KEY_V2);
          if (rawV2) {
            const arr = JSON.parse(rawV2);
            const res = normalizeProjects(arr);
            if (res.changed) {
              localStorage.setItem(PROJECTS_KEY_V2, JSON.stringify(res.list));
            }
            return res.list;
          }
          if (localStorage.getItem(MIGRATE_FLAG_KEY) === '1'){
            return normalizeProjects(DEFAULT_PROJECT_OBJS).list;
          }
          const rawV1 = localStorage.getItem(PROJECTS_KEY_OLD);
          let oldNames = [];
          if (rawV1) oldNames = JSON.parse(rawV1) || [];
          const candidates = DEFAULT_PROJECT_OBJS.map((def, i) => {
            const oldName = oldNames[i];
            return {
              id: def.id,
              name: (oldName && typeof oldName === 'string') ? oldName : def.name
            };
          });
          const norm = normalizeProjects(candidates);
          const newProjects = norm.list;
          newProjects.forEach(p => {
            const newKey = storageKeyFor(p.id);
            if (!localStorage.getItem(newKey)) {
              let oldData = localStorage.getItem(legacyStorageKeyForName(p.name)) || localStorage.getItem(legacyStorageKeyForNameOld(p.name));
              if (oldData) localStorage.setItem(newKey, oldData);
            }
          });
          localStorage.setItem(PROJECTS_KEY_V2, JSON.stringify(newProjects));
          localStorage.setItem(MIGRATE_FLAG_KEY, '1');
          return newProjects;
        } catch(e) {
          return normalizeProjects(DEFAULT_PROJECT_OBJS).list;
        }
      }

      function saveProjects(projObjArray){
        try {
          const res = normalizeProjects(projObjArray);
          localStorage.setItem(PROJECTS_KEY_V2, JSON.stringify(res.list));
          return res.list;
        } catch(e) {
          cfgSay('保存失敗: ' + e);
          return loadProjects(); 
        }
      }

      // --- UI Builders ---
      function rebuildProjectSelect(projects, keepId){
        els.projectSelect.innerHTML = '';
        projects.forEach((p, idx) => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${idx+1}. ${p.name}`;
          els.projectSelect.appendChild(opt);
        });
        if (keepId && projects.some(p => p.id === keepId)) {
          els.projectSelect.value = keepId;
        } else {
          els.projectSelect.value = projects[0].id;
        }
        
        if(currentProjectId !== els.projectSelect.value) {
            flushSave();
        }
        currentProjectId = els.projectSelect.value;
      }

      function rebuildProjectConfigUI(projects){
        els.cfgList.innerHTML = ''; 
        projects.forEach((p) => {
          const row = document.createElement('div');
          row.className = 'cfgRow';
          
          const label = document.createElement('span');
          label.className = 'idLabel';
          label.textContent = `ID:${p.id}`;
          row.appendChild(label);

          const input = document.createElement('input');
          input.type = 'text';
          input.dataset.projId = p.id;
          input.value = p.name;
          input.placeholder = '作品名';
          row.appendChild(input);
          
          const delBtn = document.createElement('button');
          delBtn.className = 'danger small';
          delBtn.textContent = '削除';
          delBtn.onclick = () => handleDeleteProject(p.id, p.name);
          if (projects.length <= 1) delBtn.disabled = true;

          row.appendChild(delBtn);
          els.cfgList.appendChild(row);
        });
      }

      function getCurrentConfigNames(){
        const inputs = Array.from(els.cfgList.querySelectorAll('input[data-proj-id]'));
        return inputs.map(input => ({
          id: input.dataset.projId,
          name: input.value
        }));
      }

      function handleAddProject(){
        flushSave(); 
        const currentList = getCurrentConfigNames();
        const newId = genId();
        currentList.push({ id: newId, name: '新規作品' });
        const saved = saveProjects(currentList);
        currentProjectId = newId; 
        updateAllUI(saved);
        cfgSay('作品を追加し、選択しました。');
      }

      function handleDeleteProject(targetId, targetName){
        if (!confirm(`「${targetName}」をリストから削除しますか？`)) return;
        flushSave();

        let deleteData = false;
        if (confirm(`この作品（ID:${targetId}）の進捗データも完全に消去しますか？\n\n・「キャンセル」→ リストから消すだけ\n・「OK」→ データも削除`)){
          deleteData = true;
        }

        let currentList = getCurrentConfigNames();
        currentList = currentList.filter(p => p.id !== targetId);
        const saved = saveProjects(currentList);
        
        if (deleteData) {
          localStorage.removeItem(storageKeyFor(targetId));
          localStorage.removeItem(backupKeyFor(targetId));
          // メモリ上の状態もクリア
          if(activeStateProjectId === targetId) {
             activeState = null;
             activeCounts = null;
             activeStateProjectId = null;
             pendingSaveProjectId = null;
             if(saveDebounceTimer) { clearTimeout(saveDebounceTimer); saveDebounceTimer = null; }
          }
        }
        if (currentProjectId === targetId) {
          currentProjectId = saved[0].id;
        }
        updateAllUI(saved);
        cfgSay(`「${targetName}」を削除しました。`);
      }

      function updateAllUI(projects){
        rebuildProjectSelect(projects, currentProjectId);
        rebuildProjectConfigUI(projects);
        refreshMainView(); 
        scheduleDashboardUpdate();
      }

      // --- State Management ---
      function loadStateForId(id){
        const key = storageKeyFor(id);
        const backupKey = backupKeyFor(id);
        const rawMain = localStorage.getItem(key);
        const rawBackup = localStorage.getItem(backupKey);

        if (!rawMain && !rawBackup) return null;
        let rawObj = null;
        let loadedFromBackup = false;

        if (rawMain) {
          try {
            const parsed = JSON.parse(rawMain);
            if (isPlausibleStateObj(parsed)) rawObj = parsed;
          } catch(e) {}
        }
        if (!rawObj && rawBackup) {
          try {
            const parsed = JSON.parse(rawBackup);
            if (isPlausibleStateObj(parsed)) { rawObj = parsed; loadedFromBackup = true; }
          } catch(e) {}
        }
        if (!rawObj) return null;

        const result = sanitizeState(rawObj);
        if (loadedFromBackup || result.changed) {
          saveStateImmediate(id, result.state, { skipBackup: true });
        }
        return result.state;
      }

      function loadCurrentState(){
        return loadStateForId(currentProjectId);
      }

      function saveStateImmediate(id, state, opts = {}){
        try {
          const safe = sanitizeState(state).state;
          if (!safe) return; 
          const newJson = JSON.stringify(safe);
          const key = storageKeyFor(id);
          const backupKey = backupKeyFor(id);

          let oldRawToBackup = null;
          if (!opts.skipBackup) {
            const oldRaw = localStorage.getItem(key);
            if (oldRaw) {
              try {
                const parsed = JSON.parse(oldRaw);
                if (isPlausibleStateObj(parsed)) {
                  const san = sanitizeState(parsed);
                  if (san.state) oldRawToBackup = oldRaw; 
                }
              } catch (e) { }
            }
          }
          localStorage.setItem(key, newJson);
          if (oldRawToBackup) localStorage.setItem(backupKey, oldRawToBackup);
        } catch(e) {
          say('保存失敗: ' + e);
        }
      }

      function debouncedSave(id, state) {
        if (saveDebounceTimer) clearTimeout(saveDebounceTimer);
        pendingSaveProjectId = id; 
        
        saveDebounceTimer = setTimeout(() => {
          saveStateImmediate(pendingSaveProjectId, state);
          saveDebounceTimer = null;
          pendingSaveProjectId = null;
        }, 200); 
      }

      function flushSave() {
        if (saveDebounceTimer && activeState) {
          clearTimeout(saveDebounceTimer);
          const targetId = pendingSaveProjectId || activeStateProjectId;
          if (targetId) {
             saveStateImmediate(targetId, activeState);
          }
          saveDebounceTimer = null;
          pendingSaveProjectId = null;
        }
      }

      function setGridCols(){
        const cols = parseInt(els.cols.value, 10) || 12;
        const c = Math.max(4, Math.min(cols, 30));
        els.grid.style.setProperty('--cols', c);
      }

      function computeCounts(state){
        const counts = Array(STAGES.length).fill(0);
        if (state && state.stage) {
          for (const v of state.stage) counts[clampStage(v)]++;
        }
        return counts;
      }

      function renderStats(state){}

      // 【高速化】counts 引数を受け取って描画
      function renderLegend(counts){
        els.legend.innerHTML = ''; 
        for (const s of STAGES){
          const item = document.createElement('div');
          item.className = 'item' + (s.id === selectedStageId ? ' active' : '');
          const countText = counts ? `（${counts[s.id]}）` : '';
          
          const dot = document.createElement('span');
          dot.className = 'dot';
          dot.style.background = `var(${s.cssVar})`;
          
          item.appendChild(dot);
          item.appendChild(document.createTextNode(s.name + countText));
          item.addEventListener('click', () => {
            selectedStageId = s.id;
            // 再描画時は現在のキャッシュを渡す
            renderLegend(activeCounts); 
            say(`選択工程：${s.name}`);
          });
          els.legend.appendChild(item);
        }
      }

      function render(state){
        els.grid.innerHTML = '';
        
        activeState = state; 
        activeStateProjectId = currentProjectId;
        // 【高速化】初期ロード時にカウント計算＆キャッシュ
        activeCounts = computeCounts(state);

        renderStats(state);
        renderLegend(activeCounts);
          
        if (!state || !state.totalPages) return;
        say(`ID:${currentProjectId} のデータを表示中。`);

        const frag = document.createDocumentFragment();

        for (let i=1; i<=state.totalPages; i++){
          const idx = i-1;
          const st = state.stage[idx]; 
          const info = stageInfo(st);

          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.idx = String(idx);
          cell.style.background = `var(${info.cssVar})`;
          
          const sub = document.createElement('span');
          sub.className = 'sub';
          sub.textContent = 'p';
          
          const stageDiv = document.createElement('div');
          stageDiv.className = 'stage';
          stageDiv.textContent = info.name;
          
          cell.appendChild(sub);
          cell.appendChild(document.createTextNode(i));
          cell.appendChild(stageDiv);

          frag.appendChild(cell);
        }
        els.grid.appendChild(frag);
      }

      function handleCellInteraction(idx, dir) {
        if (!activeState || !activeState.stage) return;
        
        const max = STAGES.length - 1;
        const prev = activeState.stage[idx]; // 変更前
        let next = clampStage(prev) + dir;
        if (next > max) next = 0;
        if (next < 0) next = max;

        // 状態更新
        activeState.stage[idx] = next;
        
        // 【堅牢化】差分更新の安全策
        if (activeCounts) {
            const p = clampStage(prev);
            // 既に0以下の場合はズレているので再同期
            if(activeCounts[p] > 0) {
                activeCounts[p]--;
                activeCounts[next]++;
            } else {
                activeCounts = computeCounts(activeState);
            }
        } else {
            // countsがnullの場合も再計算
            activeCounts = computeCounts(activeState);
        }

        // UI即時更新
        const cell = els.grid.children[idx]; 
        if (cell) {
            const ni = stageInfo(next);
            cell.style.background = `var(${ni.cssVar})`;
            const stDiv = cell.querySelector('.stage');
            if(stDiv) stDiv.textContent = ni.name;
        }

        // キャッシュ済みカウントで凡例更新 (高速)
        renderStats(activeState);
        renderLegend(activeCounts);
        
        // 【負荷軽減】ダッシュボード更新は重いので更新間隔を緩和
        scheduleDashboardUpdate();

        debouncedSave(activeStateProjectId, activeState);
      }

      els.grid.addEventListener('click', (ev) => {
        const cell = ev.target.closest('.cell');
        if(!cell) return;
        ev.preventDefault();
        const idx = Number(cell.dataset.idx);
        if(!Number.isFinite(idx)) return;
        handleCellInteraction(idx, ev.shiftKey ? -1 : 1);
      });

      els.grid.addEventListener('contextmenu', (ev) => {
        const cell = ev.target.closest('.cell');
        if(!cell) return;
        ev.preventDefault();
        const idx = Number(cell.dataset.idx);
        if(!Number.isFinite(idx)) return;
        handleCellInteraction(idx, 1);
      });


      function buildFromInputs(){
        const total = parseInt(els.totalPages.value, 10);
        if (!total || total < 1){ say('ページ数が未入力です。'); return; }
        if (total > 5000){ say('ページ数が大きすぎます。'); return; }
        setGridCols();

        const loaded = loadCurrentState();
        const stageArr = loaded && loaded.stage ? loaded.stage : [];
        const newStage = Array.from({length: total}, (_, i) => {
          return stageArr[i] !== undefined ? clampStage(stageArr[i]) : 0;
        });

        const newState = { totalPages: total, stage: newStage };
        saveStateImmediate(currentProjectId, newState); 
        render(newState);
        scheduleDashboardUpdate();
      }

      function refreshMainView(){
        const st = loadCurrentState();
        if (st && st.totalPages){
          els.totalPages.value = st.totalPages;
          setGridCols();
          render(st);
        } else {
          els.grid.innerHTML = '';
          els.stats.innerHTML = '';
          activeState = null;
          activeCounts = null;
          activeStateProjectId = null;
          renderLegend(null);
          say(`ID:${currentProjectId} は未作成です。`);
        }
        scheduleDashboardUpdate();
      }

      // --- Dashboard ---
      let dashTimer = null;
      function scheduleDashboardUpdate(){
        if (dashTimer) clearTimeout(dashTimer);
        // 【負荷軽減】400msへ緩和
        dashTimer = setTimeout(()=>{
          refreshDashboard();
          highlightDashboard();
          dashTimer = null;
        }, 400);
      }

      function pct(n, d){
        if (!d) return 0;
        return Math.max(0, Math.min(100, Math.round((n/d)*100)));
      }

      function makeDashCard(projectObj, isActive){
        const { id, name } = projectObj;
        let st = null;
        if(id === activeStateProjectId && activeState) {
            st = activeState; 
        } else {
            st = loadStateForId(id);
        }
          
        const total = st?.totalPages ?? 0;
        const counts = st ? computeCounts(st) : Array(STAGES.length).fill(0);
        const done = counts[7] || 0;
        const fixes = counts[8] || 0;
        const remain = total ? (total - done) : 0;
        const p = pct(done, total);

        const card = document.createElement('div');
        card.className = 'dashCard' + (isActive ? ' active' : '');
        card.dataset.projId = id;

        const dashTop = document.createElement('div');
        dashTop.className = 'dashTop';
        const dashTitle = document.createElement('div');
        dashTitle.className = 'dashTitle';
        dashTitle.title = name;
        dashTitle.textContent = name;
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = total ? total + 'P' : '未作成';
        dashTop.appendChild(dashTitle);
        dashTop.appendChild(badge);

        const bar = document.createElement('div');
        bar.className = 'bar';
        const barInner = document.createElement('div');
        barInner.style.width = p + '%';
        bar.appendChild(barInner);

        const dashNums = document.createElement('div');
        dashNums.className = 'dashNums';
        function createMini(dotVar, txt){
            const m = document.createElement('div');
            m.className = 'mini';
            if(dotVar){
                const d = document.createElement('span');
                d.className = 'dot';
                d.style.background = `var(${dotVar})`;
                m.appendChild(d);
            }
            m.appendChild(document.createTextNode(txt));
            return m;
        }
        dashNums.appendChild(createMini('--c7', `完${done}`));
        dashNums.appendChild(createMini('--c8', `修${fixes}`));
        dashNums.appendChild(createMini('--c0', `残${remain}`));
        dashNums.appendChild(createMini(null, `${p}%`));

        const stageLine = document.createElement('div');
        stageLine.className = 'stageLine';
        STAGES.filter(s => s.id !== 0).forEach(s => {
            const c = counts[s.id] || 0;
            const chip = document.createElement('div');
            chip.className = 'stageChip';
            const dot = document.createElement('span');
            dot.className = 'dot';
            dot.style.background = `var(${s.cssVar})`;
            const txt = document.createElement('span');
            txt.className = 'txt';
            txt.textContent = s.name;
            chip.appendChild(dot);
            chip.appendChild(txt);
            chip.appendChild(document.createTextNode(' ' + c));
            stageLine.appendChild(chip);
        });

        card.appendChild(dashTop);
        card.appendChild(bar);
        card.appendChild(dashNums);
        card.appendChild(stageLine);

        card.addEventListener('click', ()=>{
          flushSave(); 
          els.projectSelect.value = id;
          currentProjectId = id;
          refreshMainView();
        });
        return card;
      }

      function refreshDashboard(){
        const projects = loadProjects();
        els.dash.innerHTML = '';
        projects.forEach(p => {
          const isActive = (p.id === currentProjectId);
          els.dash.appendChild(makeDashCard(p, isActive));
        });
      }

      function highlightDashboard(){
        Array.from(els.dash.children).forEach(el => {
          el.classList.toggle('active', el.dataset.projId === currentProjectId);
        });
      }

      // --- Event Listeners ---
      els.projectSelect.addEventListener('change', ()=>{
        flushSave(); 
        currentProjectId = els.projectSelect.value;
        refreshMainView();
      });

      els.buildBtn.addEventListener('click', buildFromInputs);

      els.setStageBtn.addEventListener('click', ()=>{
        flushSave();
        const st = loadCurrentState();
        if (!st){ say('データがありません。'); return; }
        st.stage = st.stage.map(()=> selectedStageId);
        saveStateImmediate(currentProjectId, st); 
        render(st);
        scheduleDashboardUpdate();
      });

      els.clearBtn.addEventListener('click', ()=>{
        flushSave();
        const st = loadCurrentState();
        if (!st){ say('データがありません。'); return; }
        st.stage = st.stage.map(()=> 0);
        saveStateImmediate(currentProjectId, st); 
        render(st);
        scheduleDashboardUpdate();
      });

      els.resetBtn.addEventListener('click', ()=>{
        flushSave();
        if (!confirm('この作品の進捗データをリセットしますか？')) return;
        localStorage.removeItem(storageKeyFor(currentProjectId));
        localStorage.removeItem(backupKeyFor(currentProjectId));
        
        activeState = null;
        activeCounts = null;
        activeStateProjectId = null;
        pendingSaveProjectId = null;
        if(saveDebounceTimer) { clearTimeout(saveDebounceTimer); saveDebounceTimer = null; }

        refreshMainView();
        say('リセットしました。');
      });

      els.restoreBtn.addEventListener('click', ()=>{
        flushSave();
        if(!confirm('バックアップから復元しますか？')) return;
        const backupKey = backupKeyFor(currentProjectId);
        const raw = localStorage.getItem(backupKey);
        if(!raw) { say('バックアップなし'); return; }
        try {
            const parsed = JSON.parse(raw);
            if (!isPlausibleStateObj(parsed)) return;
            const res = sanitizeState(parsed);
            if(res.state) {
                saveStateImmediate(currentProjectId, res.state, { skipBackup: true });
                refreshMainView(); 
                scheduleDashboardUpdate();
                say('復元しました。');
            }
        } catch(e) { say('失敗:'+e); }
      });

      els.cols.addEventListener('change', setGridCols);
      els.addProjectBtn.addEventListener('click', handleAddProject);
      
      els.saveProjectsBtn.addEventListener('click', ()=>{
        const currentList = getCurrentConfigNames();
        const saved = saveProjects(currentList);
        updateAllUI(saved);
        cfgSay('登録名を保存しました。');
      });

      els.resetProjectsBtn.addEventListener('click', ()=>{
        if(!confirm('リストを初期状態（4件）に戻しますか？')) return;
        localStorage.removeItem(PROJECTS_KEY_V2);
        localStorage.removeItem(MIGRATE_FLAG_KEY);
        const list = loadProjects(); 
        updateAllUI(list);
        cfgSay('リストを初期化しました。');
      });

      // 【安全対策】離脱時フラッシュ
      window.addEventListener('pagehide', () => { flushSave(); }, { capture: true });
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') flushSave();
      }, { capture: true });
      window.addEventListener('beforeunload', () => { flushSave(); });

      // --- Init ---
      const projects = loadProjects();
      if (!projects.some(p => p.id === currentProjectId)) {
        currentProjectId = projects[0].id;
      }
      updateAllUI(projects);
      setGridCols();

    })();
  </script>
</body>
</html>



